<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="App para split de despesas em viagens com convers√£o de moedas - UnexViagem">
  <title>UnexViagem - Gerencie Despesas de Viagens</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Estilos originais (mantidos/ajustados minimamente) */

    #main-header {
      text-align: center;
      margin-bottom: 40px;
      color: #495057;
    }

    #main-header h1 {
      margin-bottom: 15px;
      color: #495057;
    }

    #main-header p {
      font-size: 1.1rem;
      color: #6c757d;
    }

    /* Centralizar o bot√£o de sair */
    .logout-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    /* Ajustar a se√ß√£o "Veja as Despesas" para n√£o parecer pequena */
    .stat-card h3 {
      font-size: 1.3rem;
      color: #495057;
      margin-bottom: 15px;
    }

    .stat-card p {
      font-size: 1.1rem;
      line-height: 1.6;
      color: #6c757d;
    }

    /* Estilos do Bot√£o Secund√°rio (logout/default) */
    .btn-secondary {
      background-color: #6c757d;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      /* Adicionado para consist√™ncia */
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    /* Estilos do Bot√£o de Logout */
    .logout-btn {
      background-color: #0056b3;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      /* Adicionado para consist√™ncia */
    }

    .logout-btn:hover {
      background-color: #004085;
    }

    /* Melhorar espa√ßamento geral */
    .stat-card {
      margin-bottom: 20px;
      padding: 30px;
      background-color: #ffffff;
      /* Garante fundo branco nas cards */
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    /* ================================================= */
    /* ESTILOS EXCLUSIVOS PARA AS TELAS DE LOGIN/REGISTER */
    /* ================================================= */

    /* Garante que o fundo do corpo seja cinza claro SOMENTE quando n√£o logado */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
    }

    /* Aplica o fundo cinza claro apenas quando a p√°gina de login/register est√° ativa */
    #login-page.active,
    #register-page.active {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f0f2f5;
      /* Fundo cinza claro */
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
      z-index: 1000;
      /* Garante que fique por cima de outros elementos se houver */
    }

    /* Garante que o main-content n√£o tenha margem quando na tela de login */
    #login-page.active~.main-content,
    #register-page.active~.main-content {
      margin-left: 0;
    }

    .main-content {
      margin-left: 0;
      padding-top: 20px;
    }

    /* 1. Estilo do Cont√™iner do Formul√°rio (o "cart√£o" branco) */
    #login-page .form-container,
    #register-page .form-container {
      background-color: #ffffff;
      padding: 45px;
      /* Um pouco mais de padding */
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      width: 100%;
      max-width: 450px;
      /* **Aumentado para desktop** */
      box-sizing: border-box;
      text-align: center;
    }

    #login-page .form-container h1,
    #register-page .form-container h1 {
      font-weight: 500;
      color: #007bff;
      /* **Usando o azul prim√°rio do site** */
      margin-bottom: 20px;
      font-size: 2.5rem;
      /* **Aumentado para desktop** */
      letter-spacing: -1px;
    }

    #login-page .form-container p,
    #register-page .form-container p {
      color: #8e8e8e;
      margin-bottom: 35px;
      /* Mais espa√ßo abaixo da descri√ß√£o */
      font-size: 1rem;
      /* Ligeiramente maior */
    }

    /* 2. Estilo dos Inputs e Labels (ocultando labels e ajustando inputs) */
    #login-page .form-group,
    #register-page .form-group {
      margin-bottom: 18px;
      /* Mais espa√ßo entre inputs */
      text-align: left;
    }

    #login-page .form-group label,
    #register-page .form-group label {
      display: none;
    }

    #login-page .form-container input,
    #register-page .form-container input {
      width: 100%;
      padding: 14px 12px;
      /* Maior padding nos inputs */
      border: 1px solid #ced4da;
      /* Borda mais neutra e padr√£o */
      border-radius: 5px;
      /* Levemente mais arredondado */
      box-sizing: border-box;
      background-color: #ffffff;
      /* Fundo branco nos inputs */
      font-size: 1rem;
      color: #262626;
    }

    #login-page .form-container input::placeholder,
    #register-page .form-container input::placeholder {
      color: #adb5bd;
      /* Placeholder mais vis√≠vel */
    }

    #login-page .form-container input:focus,
    #register-page .form-container input:focus {
      border-color: #007bff;
      /* Borda azul ao focar */
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      /* Sombra de foco azul */
      outline: none;
    }

    /* 3. Estilo do Bot√£o Prim√°rio (Login/Criar Conta) - Sobrescrito apenas para o login */
    #login-page .btn-primary,
    #register-page .btn-primary {
      width: 100%;
      padding: 14px;
      /* Bot√£o maior */
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      /* **Azul prim√°rio do site** */
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
      /* Fonte maior no bot√£o */
      cursor: pointer;
      transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      margin-top: 25px;
      /* Mais espa√ßo */
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
      /* Sombra sutil para o bot√£o */
    }

    #login-page .btn-primary:hover,
    #register-page .btn-primary:hover {
      background-color: #0056b3;
      /* Azul mais escuro no hover */
      box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3);
    }

    /* 4. Link de Altern√¢ncia (Criar Conta / Fazer Login) */
    #login-page .link-switch,
    #register-page .link-switch {
      margin-top: 30px;
      /* Mais espa√ßo */
      font-size: 1rem;
      color: #6c757d;
      /* Cor mais neutra */
    }

    #login-page .link-switch a,
    #register-page .link-switch a {
      color: #007bff;
      /* **Azul prim√°rio do site** */
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    #login-page .link-switch a:hover,
    #register-page .link-switch a:hover {
      text-decoration: underline;
      color: #0056b3;
    }
  </style>
</head>

<body>
  <nav class="sidebar" id="sidebar" style="display: none;">
    <div class="sidebar-header">
      <h2>UnexViagem</h2>
    </div>
    <ul class="sidebar-nav">
      <li><a href="#" onclick="showPage('despesas-page')" class="active">üí∞ UnexViagem</a></li>
      <li><a href="dashboard.html">üìä Dashboard</a></li>
      <li><a href="minhas-viagens.html">‚úàÔ∏è Minhas Viagens</a></li>
      <li><a href="solicitar.html">üìù Solicitar Viagem</a></li>
      <li><a href="relatorios.html">üí∞ Relat√≥rios</a></li>
      <li><a href="configuracoes.html">‚öôÔ∏è Configura√ß√µes</a></li>
    </ul>
  </nav>

  <main class="main-content" id="main-content">
    <header id="main-header" style="display: none;">
      <h1>üöÄ UnexViagem</h1>
      <p>Gerencie despesas de viagens de forma simples e inteligente</p>
    </header>

    <div id="login-page" class="page active">
      <div class="form-container">
        <h1>‚úàÔ∏è UnexViagem</h1>
        <p>Entre na sua conta e comece a gerenciar suas viagens.</p>
        <form onsubmit="event.preventDefault(); handleLogin();">
          <div class="form-group">
            <label for="login-email">Email</label>
            <input id="login-email" type="email" placeholder="nome@empresa.com" required />
          </div>
          <div class="form-group">
            <label for="login-password">Senha</label>
            <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
          </div>
          <button type="submit" class="btn btn-primary">Entrar na Conta üîë</button>
        </form>
        <p class="link-switch">
          N√£o tem conta? <a href="#" onclick="showPage('register-page')">Criar Conta</a>
        </p>
      </div>
    </div>

    <div id="register-page" class="page">
      <div class="form-container">
        <h1>‚ûï Nova Conta</h1>
        <p>Crie sua conta gratuita na UnexViagem.</p>
        <form onsubmit="event.preventDefault(); handleRegister();">
          <div class="form-group">
            <label for="register-email">Email</label>
            <input id="register-email" type="email" placeholder="nome@empresa.com" required />
          </div>
          <div class="form-group">
            <label for="register-password">Senha (m√≠n. 6 caracteres)</label>
            <input id="register-password" type="password" placeholder="Crie uma senha segura" required />
          </div>
          <button type="submit" class="btn btn-primary">Criar Conta Agora ‚ú®</button>
        </form>
        <p class="link-switch">
          J√° tem conta? <a href="#" onclick="showPage('login-page')">Fazer Login</a>
        </p>
      </div>
    </div>

    <!-- P√°gina de Despesas e Viagens -->
    <div id="despesas-page" class="page">
      <h2>Bem-vindo de volta! üíº</h2>
      <p>Crie viagens, adicione despesas e calcule automaticamente.</p>

      <!-- Criar Nova Viagem -->
      <div class="stat-card">
        <h3>Criar Nova Viagem üó∫Ô∏è</h3>
        <form onsubmit="event.preventDefault(); handleAddTrip();">
          <div class="form-group">
            <label for="trip-name">Nome da Viagem</label>
            <input id="trip-name" placeholder="Ex: Viagem para Itacar√©" required />
          </div>
          <div class="form-group">
            <label for="trip-start-date">Data de In√≠cio</label>
            <input id="trip-start-date" type="date" required />
          </div>
          <div class="form-group">
            <label for="trip-end-date">Data de Fim</label>
            <input id="trip-end-date" type="date" required />
          </div>
          <button type="submit" class="btn btn-success">Criar Viagem ‚ûï</button>
        </form>
      </div>

      <!-- Minhas Viagens -->
      <div class="stat-card">
        <h3>Minhas Viagens üë•</h3>
        <div class="form-group">
          <label for="trip-filter">Selecionar Viagem</label>
          <select id="trip-filter" onchange="filtrarViagem()">
            <option value="all">Mostrar todas</option>
          </select>
        </div>
        <div id="viagem-detalhes" style="display: none; margin-top: 20px;"> <!-- Aumentado margin-top -->
          <p><strong>Detalhes da Viagem:</strong></p>
          <p id="viagem-info">Selecione uma viagem para ver detalhes.</p>
        </div>
      </div>

      <!-- Adicionar Nova Despesa -->
      <div class="stat-card">
        <h3>Adicionar Nova Despesa üìà (Selecione uma Viagem Primeiro)</h3>
        <form onsubmit="event.preventDefault(); handleAddDespesa();">
          <div class="form-group">
            <label for="despesa-name">Nome da Despesa</label>
            <input id="despesa-name" placeholder="Ex: Gasolina" required />
          </div>
          <div class="form-group">
            <label for="despesa-amount">Valor</label>
            <input id="despesa-amount" type="number" step="0.01" placeholder="Ex: 25.75" required />
          </div>
          <div class="form-group">
            <label for="despesa-currency">Moeda</label>
            <select id="despesa-currency">
              <option value="BRL">BRL (R$)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="despesa-trip">Viagem</label>
            <select id="despesa-trip">
              <option value="" disabled>Selecione uma viagem (crie se necess√°rio)</option>
            </select>
          </div>
          <button id="add-despesa-btn" type="submit" disabled class="btn btn-primary">Adicionar Despesa ‚ûï</button>
        </form>
      </div>

      <!-- Veja as Despesas (Link para Dashboard) -->
      <div class="stat-card">
        <h3>Veja as Despesas üí∞</h3>
        <p>Para visualizar e gerenciar todas as suas despesas, acesse o <a href="dashboard.html" style="color: #007bff; text-decoration: none; font-weight: 500;">Dashboard</a>.</p>
      </div>

      <div id="split-result" class="stat-card"></div>

      <!-- Bot√£o centralizado de sair (removido o "Voltar ao Login") -->
      <div class="logout-buttons">
        <button onclick="handleLogout()" class="btn btn-secondary logout-btn">Sair üö™</button>
      </div>
    </div>
  </main>

  <script>
    // Configura√ß√µes
    const API_BASE = 'http://localhost:4000/api';
    let token = localStorage.getItem('token');
    let user = JSON.parse(localStorage.getItem('user') || 'null');
    let trips = []; // <-- vari√°vel global para armazenar as viagens

    // Fun√ß√£o para mostrar/ocultar sidebar e header baseado no login
    function updateUI() {
      const sidebar = document.getElementById('sidebar');
      const header = document.getElementById('main-header');
      const mainContent = document.getElementById('main-content');

      if (token && user) {
        sidebar.style.display = 'block';
        header.style.display = 'block';
        mainContent.style.marginLeft = '240px';
      } else {
        sidebar.style.display = 'none';
        header.style.display = 'none';
        mainContent.style.marginLeft = '0';
      }
    }

    // Inicializa√ß√£o
    updateUI();
    if (token && user) {
      showPage('despesas-page');
    }

    // Mostrar p√°gina (SPA)
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      updateUI();

      if (pageId === 'despesas-page' && token) {
        loadTrips();
      }
    }

    // Fetch com token
    async function apiFetch(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json', ...options.headers };
      if (token) headers.Authorization = `Bearer ${token}`;

      const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });

      if (response.status === 401) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        token = null;
        user = null;
        updateUI();
        showPage('login-page');
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
      }

      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      return response.json();
    }

    // Login
    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      if (!email || !password) return alert('Preencha email e senha.');

      try {
        const { token: newToken, user: newUser } = await apiFetch('/users/login', {
          method: 'POST',
          body: JSON.stringify({ email, password })
        });

        token = newToken;
        user = newUser;

        localStorage.setItem('token', token);
        localStorage.setItem('user', JSON.stringify(user));

        updateUI();
        showPage('despesas-page');

      } catch (err) {
        alert('‚ùå Erro no login: ' + err.message);
      }
    }

    // Register
    async function handleRegister() {
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value.trim();

      if (!email || !password || password.length < 6 || !email.includes('@')) {
        alert('Valida√ß√£o falhou: Email v√°lido e senha ‚â•6 chars obrigat√≥rios.');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/users/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          alert('‚úÖ Conta criada!');
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          showPage('login-page');
        } else {
          alert('‚ùå Erro no registro: ' + (data.error || 'Erro desconhecido'));
        }

      } catch (error) {
        alert('Erro de conex√£o. Backend rodando na porta 4000?');
      }
    }

    // Criar viagem
    async function handleAddTrip() {
      const name = document.getElementById('trip-name').value;
      const startDate = document.getElementById('trip-start-date').value;
      const endDate = document.getElementById('trip-end-date').value;

      if (!name || !startDate || !endDate) return alert('Preencha nome e datas.');
      if (new Date(startDate) >= new Date(endDate)) return alert('Data de in√≠cio deve ser antes da de fim.');

      try {
        await apiFetch('/trips', {
          method: 'POST',
          body: JSON.stringify({
            name,
            start_date: startDate,
            end_date: endDate
          })
        });

        alert('Viagem criada!');
        document.getElementById('trip-name').value = '';
        document.getElementById('trip-start-date').value = '';
        document.getElementById('trip-end-date').value = '';
        loadTrips();

      } catch (err) {
        alert('Erro ao criar viagem: ' + err.message);
      }
    }

    // Adicionar despesa
    async function handleAddDespesa() {
      const name = document.getElementById('despesa-name').value;
      const amount = parseFloat(document.getElementById('despesa-amount').value);
      const currency = document.getElementById('despesa-currency').value;
      const tripId = document.getElementById('despesa-trip').value;

      if (!name || !amount || !tripId) return alert('Preencha todos os campos.');

      try {
        await apiFetch('/expenses', {
          method: 'POST',
          body: JSON.stringify({ name, amount, currency, trip_id: tripId })
        });

        alert('Despesa adicionada!');
        document.getElementById('despesa-name').value = '';
        document.getElementById('despesa-amount').value = '';

      } catch (err) {
        alert('Erro ao adicionar despesa: ' + err.message);
      }
    }

    // Formatar data para dd/mm/yyyy
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const d = new Date(dateStr);
      return d.toLocaleDateString('pt-BR');
    }

    // Filtrar viagem e mostrar detalhes com datas
    function filtrarViagem() {
      const filter = document.getElementById('trip-filter').value;
      const detalhes = document.getElementById('viagem-detalhes');
      const info = document.getElementById('viagem-info');

      if (filter === 'all') {
        detalhes.style.display = 'none';
        info.textContent = 'Selecione uma viagem para ver detalhes.';
      } else {
        detalhes.style.display = 'block';
        const trip = trips.find(t => t.id == filter);
        if (trip) {
          info.innerHTML = `
          <strong>Nome:</strong> ${trip.name}<br>
          <strong>In√≠cio:</strong> ${formatDate(trip.start_date)}<br>
          <strong>Fim:</strong> ${formatDate(trip.end_date)}
        `;
        }
      }
    }

    // Carregar viagens do usu√°rio
    async function loadTrips() {
      try {
        const userId = user?.id;
        if (!userId) {
          alert("Usu√°rio n√£o encontrado. Fa√ßa login novamente.");
          return;
        }

        const data = await apiFetch(`/trips`);
        trips = data.trips || [];

        const tripFilter = document.getElementById('trip-filter');
        const tripSelectDespesa = document.getElementById('despesa-trip');

        tripFilter.innerHTML = `<option value="all">Mostrar todas</option>`;
        tripSelectDespesa.innerHTML = `<option value="" disabled selected>Selecione uma viagem</option>`;

        trips.forEach(trip => {
          const opt1 = document.createElement('option');
          opt1.value = trip.id;
          opt1.textContent = trip.name;
          tripFilter.appendChild(opt1);

          const opt2 = document.createElement('option');
          opt2.value = trip.id;
          opt2.textContent = trip.name;
          tripSelectDespesa.appendChild(opt2);
        });

        document.getElementById('add-despesa-btn').disabled = trips.length === 0;

      } catch (err) {
        console.error("Erro ao carregar viagens:", err);
        alert("Erro ao carregar suas viagens.");
      }
    }

    // Logout
    function handleLogout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      token = null;
      user = null;
      updateUI();
      showPage('login-page');
      alert('üëã Sa√≠da do UnexViagem! Volte sempre.');
    }

    window.addEventListener('submit', e => e.preventDefault());
  </script>


</body>

</html>